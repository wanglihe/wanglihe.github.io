<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="王礼鹤" />
    <meta name="generator" content="Pelican (VoidyBootstrap theme)" />

    <title>一种通用文件格式的思考 - 王礼鹤的博客</title>



      <link rel="stylesheet" href="/theme/css/bootstrap.min.css" />
      <link rel="stylesheet" href="/theme/css/font-awesome.min.css" />
      <link rel="stylesheet" href="/theme/css/pygment.css" />
      <link rel="stylesheet" href="/theme/css/voidybootstrap.css" />

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="shortcut icon" href="/favicon.ico" />
  </head>

  <body>
   
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
	   <div class="navbar-header">
		<button type="button" class="navbar-toggle" 
				data-toggle="collapse" data-target="#main-navbar-collapse">
		  <span class="sr-only">Toggle navigation</span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		  <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="/" rel="home">
          <i class="fa fa-home fa-fw fa-lg"> </i> </a>
       </div>

      <div class="collapse navbar-collapse" id="main-navbar-collapse">
        <ul class="nav navbar-nav">
              <li>
                <a href="/pages/关于.html">关于</a>
              </li>
              <li>
                <a href="/pages/求职.html">求职</a>
              </li>
            <li class="divider"></li>
            <li class="">
              <a href="/archives.html">Archives</a>
            </li>
          <li class="divider"></li>
        </ul> <!-- /nav -->
      </div> <!-- /navbar-collapse -->
	  </div> <!-- /container -->
    </nav> <!-- /navbar -->

	<div class="jumbotron" id="overview">
	  <div class="container">
		<h1><a href="/">王礼鹤的博客</a></h1>
		<p class="lead">——关注稳定实时高并发（学海无涯，回头是岸）（有钱就任性，没钱就认命）（麻雀虽小，五毒俱全）（并行是世界的本质，实时是生命的基础）</p>
	  </div>
	</div>

    <div class="container" id="main-container">
      <div class="row">
        <div class="col-md-9" id="content">
<article itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
  <header class="article-header">
<abbr class="article-header-date">
  Sat 16 April 2016
</abbr> <h1>
  <a href="/一种通用文件格式的思考.html" rel="bookmark"
     title="Permalink to 一种通用文件格式的思考">
    一种通用文件格式的思考
  </a>
</h1><div class="article-header-info">
  <p>
      Posted by <a href="/author/wanglihe.html">wanglihe</a>
    in 
    <a href="/category/uncategorized.html">
      Uncategorized</a>
    &nbsp;&nbsp;
  </p>
</div> <!-- /.article-header-info -->  </header>
  <div class="content-body" itemprop="text articleBody">
	<p>我们每一天都在用计算机处理各种数据。等等，重新思考一下，我们真的只在处理数据吗？
不只，我们其实主要在处理各种“文件”，从中得到数据，又把数据存回到文件中。比如：
我们处理今天的会议纪要，其实我们处理了文字数据，并将文字存在了一份文档文件中。
我们修改了一项系统服务的配置选项，其实是将配置项从文件中读出来，修改后再存回文件
中，而系统服务重新从配置文件中读出配置项并使之生效。</p>
<p>那么什么是文件呢？我觉得我们似乎没有给文件本身下一下恰当的定义，再加上unix系统“一
切皆是文件”的宣传，使本就雾里看花的文件愈加扑朔迷离。我觉得是时候好好的说一下什么是
文件了。给文件本身下一个定义，并且让文件成为更好的处理数据的工具。</p>
<p>按照传统一些，或者说直觉上来说，文件是这么一种东西：计算机处理数据，处理好了就需
要存起来，以供之后使用。这种东西存在磁盘上，有一个确定的文件名，有时候有一个扩展
名，两者加在一起，可以确定一个文件的存储位置，部分的确定文件的类型。后来文件太多
了，经常遇到重名，于是磁盘上升级出一套叫做文件系统的东西，文件存在文件系统里，可
以把文件分门别类放在各种目录中。目录本身是可以嵌套的，于是就有了多级目录。有了文件
系统和多级目录体系，文件就了以由目录，文件名及扩展名唯一确定，程序打开关闭文件就不
会再乱了。这些存起来的文件，都是有类型的，除了扩展名，还可以通过内部数据确定，特定的类型需要特
定的程序才能进行数据读写，否则会读不出正确的数据，甚至是损坏数据。好了，现在文件
可以随时被打开，经过特定的程序进行读写修改后再关闭，将新数据保存在磁盘上，当然，
虽然数据格式和内容各不相同，但存储的底层都是二进制数据。后来
unix系统觉得文件管理起来很方便，而且计算机的整体管理也和文件很“神似”，于是就把
计算机的几乎所有的组件都统一成类似于文件的东西处理。于是，硬盘，可以当做文件，放
在某些其实并不是真实文件系统，而是虚拟出的目录中进行管理；某个程序内的网络连接，也可以当成一
个打开的文件进行读写。以上就是传统文件的基本定义了，总体来说，我觉得文件主要有三
个特性：</p>
<ol class="arabic simple">
<li>系统内部唯一确定，主要是目录及文件名的管理体系</li>
<li>文件支持打开，关闭，读写这些操作，读写操作可以在底层统一成二进制的读写。</li>
<li>文件内部有特别的结构，需要特定的程序读写。</li>
</ol>
<p>那么我觉得传统文件的定义应该是：可以被唯一确定访问的存储二进制数据的实体，而至于
文件系统什么的并不重要。而unix文件其实不是文件，应该叫做基于二进制可访问，具有读写
机制的系统服务使用接口。unix文件纯属添乱，本文要讨论的也不是unix文件。</p>
<p>但是更进一步，文件应该仅仅解释为传统意义吗？我觉得不是。我们想一想文件都是如何被
保存和使用的。文件总是由一个程序写入后关闭，再由别一个程序打开后进行相关操作，关
闭，然后再由另一个程序打开，周而复始，直到文件被删除。程序运行起来之后，都是一个
个系统进程，所以上文可以表述成一个进程创建了文件，再由下一个进程读写，再传递给下
一个进程。对比一下普通的进程间通信（ipc），不难看出，文件其实不过是另一种进程间通
信，与普通的进程间通信不同仅仅在于，普通的进程间通信，通信双方的进程是同时存活的，
而用文件进行通信的进程，往往不同时存活。也就是说，文件，其实可以被重新定义为广义
的，跨时间的进程间通信。每一个进程读写文件，其实就是与过去的进程，或是与未来的进
程进行通信。这样把文件定义为广义的进程间通信后，重新审视文件本身，我觉得文件应该
可以定义为带有唯一标识符的数据暂存通道，而其内部结构等等相关内容，不过是一种通信
协议，和最常用的 TCP/IP 协议没有本质不同。而文件的内部结构，或者说通信协议，自诞生
至今，已经太多了，是时候提出一个更通用的体系进行化简了。那么，unix先驱们曾经是怎么
处理相似的事情的呢？我们先来看看纯文本的失误。</p>
<p>unix文件引入了文件内涵的混乱，更乱的还有另一条unix哲学：一切皆是文本。这条可以理解为unix的专家们认为二进制文件
要么以纯文本文件解码，要么就要从某些规定的结构中读出数据。后者造成了需要特殊程序
才能解码，给程序间的沟通带来了不便。举个例子，一个纯文本的数据文件，我可用cat|grep|awk
快速的得某些行的第二列数据，这三个工具之间以管道连接，输入输出都是纯文本，互相之间
都很容易理解。而如果数据文件是一个有内部结构的，那不好办了，工具很难直接配合，
因为互相之间需要知道其他工具的输出的结构，否则得不到数据。那么其结果就是需要特别
开发一个软件，把所有要做的工作全都写出来编译好执行，然后才能得到结果。更麻烦的又来了，
如果现在要求把刚才的结果中某些字符做统一替换，那么纯文本只要再加一个sed工具，而
独立开发的可能又要哭着加班了。</p>
<p>但是以上的例子只要好好想想就发现unix的专家们只是一
群本着够用就行的实用主义妖孽。他们为了掩饰自己只是懒得想得更多而妖魔化了二进制的
文件处理。同时纯文本就完全没有问题吗？有，问题还不小。先说说纯文本出了什么问题。
纯文本的思路简单的将数据的存储和内容本身等同化了。什么意思呢？就是说，纯文本认为
它存的东西，就是它想存的，最好直接映射，而没有任何变换。比如存储一个整数，那么存
的内容就是12345这样的一串字符，这样读出来就是12345，不用做任何变换。存储的内部没有
结构，所以无论用什么工具读出，得到的都是一样的字符串，这样似乎在底层将数据格式统
一了，所以任意两个程序之间沟通的接口都是一致的。但是这个假设其实是错的，存储和内
容并不等同。存储的目标是通用性，而内容一定的特化的。纯文本文件内的数据只要一多，
一定会引入结构，比如行、列、分割符以致更为复杂的树形结构像臭名远扬的xml和被大为
赞赏但实际上和xml一样臭的html，还有最近的新宠json以及远古的旧爱csv。这些都是构建
在纯文本“一致性”幻像上的不一致的各种结构。所以纯文本并没有解决它想解决的问题，如
果说二进制文件因为内部有结构而没有通用性，那么输出格式是csv的程序同样在高级别上
无法和输入是xml的程序沟通，虽然它们能读“纯文本”，所以都是纯文本又有什么用呢？而且纯文本本身也
并不是那么的“一致”，在纯文本做为一个概念推广的时候，大约也确实没有预见到这个世界
上还有那么多“文字”，而各种文字之间的“纯文本”并不一致，在不同的字符编码下，这种编码
里面的1到了另一种编码下可能就变成了a而失去了数字的特性，出现了不同，比如中文 GBK
编码的“一”到了 ASCII 编码下就是乱码，完全没有办法解读。就算后来出现了 unicode 似乎解
决了部分问题，但是 unicode 的 UTF-8, UTF-16LE, UTF-16BE, UTF-8 with BOM 等等传输
模式，还是一样的把纯文本可以一致的让数据在不同的程序间流动的幻像击得粉碎。而纯文本
的遗害远远超过了想像。它催生了一大批为了解决自身解决不了的结构问题而诞生的各种结构
像刚才说的xml。而且“编解码”本身变成了时时都在做的浪费，比如你从文件中读取了12345，
但如果想参与运算的话，其实程序内部一定是将其转化成了一个整数，而存的时候再转回来。
编解码本身除了浪费处理时间，还浪费存储空间，比如12345只需要32个比特就能存储，但是
纯文本用最省的 ASCII 仍然要40个比特才能存储，这还只是小数据就浪费了25%，其实整体上
浪费了更多。而编解码本身，其实很容易出错，做过数据处理的一定遇到过数据溢出之类的
错误，更不用说像http, html 等等类似的各种重量级的结构化数据描述，甚至需要像编译器那样
有一个复杂的解析器才能得到其中的数据。编解码器以及解析器的编写，本身非常难，又很难写的完善，但是
因为纯文本，需要在好多不同的地方“简单”
实现一个，这几乎成了所有程序的 bug 源头之一。因为纯文本浪费存储空间，人们浪费了相当的人力智力开发
各种专门处理文本的压缩算法，甚至出现了奇怪的“xml很容易被压缩以节省存储空间”这种
似是而非的怪异论调。而为了不写编解码器和解析器，但又需要在各种高级结构上做数据处理，
于是正则表达式开始各种乱入，而一个复杂而正确的正则表达式，连智力正常的人都很难一次写对，是对
人力的一大浪费。而后甚至出现了以正则表达为基础perl脚本语言，又是一个
bug级的乱像，还催生了编程90%就是在处理字符串这种low到地心论断。
各种网络的传输和控制协议几乎都基于纯文本，理由是“调试时可以
直接看到文本而变得方便”，结果网络浪费了大量的成本来传输8个比特就能确定的东西，一
定要写成“HEAD:”，FTP, HTTP，等等全都深受其害。反过来再看看二进制，有那么不通用吗？
其实远远没有那么可怕，甚至于结构定义良好的二进制文件，很利于各个软件的沟通。比如
图像文件，视频文件，都是同一结构在各种不同的软件上传来传去。</p>
<p>纯文本其实是什么呢，到底要解决什么问题呢？其实在当年，先驱们选择纯文本，估计并不是
因为纯文本好，而是纯文本没有那么差。当年计算机的硬件结构还处在滥觞时代，所以“基础”
的二进制都不统一，比如有大尾的，小尾的，混乱尾的，运行期可改尾的，有8位机，16位的机，甚至还有32位机和4位机，
而在不同的机器上的各种高阶二进制文件更是多如牛毛。这个时候，想要一种简单的通用解决
方案，让同一份数据在不同的机器上显得比较一致，相同的网络通信协议在两边的机器上可以
被快速的调试，并不那么容易。说到底，还是想要一种通用的存储表达模式（通信模式），也就是说，纯
文本主要解决的问题其实就是存储（通信）的问题，在当时，最容易实现的方案是以8比特为基础的文字
描述方案，毕竟显示英文是一台计算机能用的硬指标，而显示英文其本上就是显示以8比特为
基础的 ASCII 码。而更底层一点的“通用的二进制”显得有些为难，机器种类太他妈多了，反
而不太容易统一，更高阶一点的结构数据存储的问题，太他妈远了，有需求再说吧。那么说开了，
纯文本是当时社会成本最优的通用存储方案，而其他的那些“优秀”特性的描述，都是扯淡。
所以，鼓吹纯文本是世界救星的那群人，估计是unix先驱们手下打杂的败类，混不下去后跑
到其他机构，仗着自己“见过世面”，unix用啥就吹啥，其实啥也不懂，只会吹啊，为了显得
比较正确，只能大骂二进制了，魂淡。而跟着二道贩子学出来的三道贩子设计了 xml、json 什么的，
我只能哀其不幸，怒其不争，你们的设计是计算机历史上的耻辱。</p>
<p>那么当前这个时代，是重新思考以上这些问题，并给出一个通用的解决方案的时候了。先定义
我想解决的问题：</p>
<ol class="arabic simple" start="0">
<li>文件，存储，应该以通信协议的眼光进行审视和设计。</li>
<li>通用存储，也就是存储本身可以在不同的机器，操作系统，工作环境下解读。</li>
<li>为适应当下的复杂的数据需求，文件内部需要支持结构。</li>
<li>文件内部应该不只有一种通用的结构，毕竟没有一种通用结构适合存储所有类型的数据，那么就需
要一种方式描述这种结构，也就是文件的某一部分是自描述的。</li>
</ol>
<p>有了以上几点，就是一种完美解决当下所有问题的合理解决方案。我觉得我会选择二进制，
16位大尾为基出存储，内部定义可以扩展的描述类型。也许名字就叫做unibin（universal binary），而经过这
东西改造过的各种文件，可以用ub放在扩展名前，比如.ubxml。似乎不错。</p>
<p>额外的好处：</p>
<ol class="arabic simple">
<li>参考网络包的设计，数据同类的部分很容易分离，连带的就是更容易更好的并行处理。</li>
<li>同一数据可以更容易的转化成易于阅读的文本表达，比如转成xml或json，现有的数据描述
方式退化成一种“人——数据”界面，做好自己的工作。转化时可以做数据验证，现有的配置
文件一类的数据，生效更为安全。</li>
<li>现有数据格式甚至可以用unibin做为中间格式互转。</li>
<li>如果能描述程序源码，那么也许将出现一种通用前端，以及某种源码互转（source-to-source comppiler)
工具。</li>
</ol>

  </div>
  

</article>
        </div><!-- /content -->

        <div class="col-md-3 sidebar-nav" id="sidebar">

<div class="row">


<div class="col-xs-6 col-md-12">
<h4><i class="fa fa-folder fa-fw fa-lg"></i> Categories</h4>
<ul class="list-unstyled category-links">
  <li><a href="/category/cong-zi-ran-shu-dao-ji-suan-ji.html" >
    <i class="fa fa-folder-open fa-fw fa-lg"></i> 从自然数到计算机</a></li>
  <li><a href="/category/uncategorized.html" >
    <i class="fa fa-folder-open fa-fw fa-lg"></i> Uncategorized</a></li>
  <li><a href="/category/wan-zhuan-vps.html" >
    <i class="fa fa-folder-open fa-fw fa-lg"></i> 玩转vps</a></li>
</ul>
</div>

</div> <!-- /row -->


<h4><i class="fa fa-tags fa-fw fa-lg"></i> Tags</h4>
<p class="tag-cloud">
<span class="tag-4">
    <a href="/tag/elf.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>elf
    </a>
</span>
<span class="tag-4">
    <a href="/tag/wei-xu.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>位序
    </a>
</span>
<span class="tag-4">
    <a href="/tag/utf-8.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>utf-8
    </a>
</span>
<span class="tag-4">
    <a href="/tag/xml.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>xml
    </a>
</span>
<span class="tag-4">
    <a href="/tag/lfs.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>lfs
    </a>
</span>
<span class="tag-4">
    <a href="/tag/fu-hao.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>符号
    </a>
</span>
<span class="tag-4">
    <a href="/tag/xiao-wei.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>小尾
    </a>
</span>
<span class="tag-4">
    <a href="/tag/zi-jie-xu.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>字节序
    </a>
</span>
<span class="tag-2">
    <a href="/tag/linux.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>linux
    </a>
</span>
<span class="tag-4">
    <a href="/tag/jie.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>节
    </a>
</span>
<span class="tag-4">
    <a href="/tag/elf64.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>elf64
    </a>
</span>
<span class="tag-4">
    <a href="/tag/vps.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>vps
    </a>
</span>
<span class="tag-4">
    <a href="/tag/semi-structured.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>semi-structured
    </a>
</span>
<span class="tag-4">
    <a href="/tag/json.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>json
    </a>
</span>
<span class="tag-4">
    <a href="/tag/semistructured.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>semistructured
    </a>
</span>
<span class="tag-4">
    <a href="/tag/smallest.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>smallest
    </a>
</span>
<span class="tag-4">
    <a href="/tag/utf8.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>utf8
    </a>
</span>
<span class="tag-1">
    <a href="/tag/shu-xue.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>数学
    </a>
</span>
<span class="tag-4">
    <a href="/tag/structured.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>structured
    </a>
</span>
<span class="tag-4">
    <a href="/tag/zi-ran-shu.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>自然数
    </a>
</span>
<span class="tag-4">
    <a href="/tag/da-wei.html">
        <i class="fa fa-tag fa-fw fa-lg"></i>大尾
    </a>
</span>
</p>


<hr />

        </div><!--/sidebar -->
      </div><!--/row-->
    </div><!--/.container /#main-container -->

    <footer id="site-footer">
 
      <address id="site-colophon">
        <p class="text-center text-muted">
        Site built using <a href="http://getpelican.com/" target="_blank">Pelican</a>
        &nbsp;&bull;&nbsp; Theme based on
        <a href="http://www.voidynullness.net/page/voidy-bootstrap-pelican-theme/"
           target="_blank">VoidyBootstrap</a> by 
        <a href="http://www.robertiwancz.com/"
           target="_blank">RKI</a>  
        </p>
      </address><!-- /colophon  -->
    </footer>


    <!-- javascript -->

    <script src="/theme/js/bootstrap.min.js" ></script>

  </body>
</html>